
name: "Push to decodable AWS codeartifact"
on:
  workflow_dispatch:
  push:
    branches:
      - main
      - 'release-*'
    tags:
      - 'release-*-rc*'
jobs:
  build_n_push:
    runs-on: ubuntu-latest
    steps:
      - name: Check out the repo
        uses: actions/checkout@v2
      - name: Set up JDK 11
        uses: actions/setup-java@v2
        with:
          java-version: '11'
          distribution: 'adopt'
          cache: maven
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.PROD_AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.PROD_AWS_SECRET_ACCESS_KEY }}
          aws-region: us-west-2
      - name: Fetch AWS CodeArtifact token
        run: echo CODEARTIFACT_AUTH_TOKEN=$(aws codeartifact get-authorization-token --region us-west-2 --domain decodable --domain-owner 671293015970 --query authorizationToken --output text ) >> $GITHUB_ENV
      - name: maven-settings-xml-action
        uses: whelk-io/maven-settings-xml-action@v20
        with:
          servers: >
            [
              {
                "id": "decodable-mvn-releases-local",
                "username": "aws",
                "password": "${env.CODEARTIFACT_AUTH_TOKEN}"
              },
            {
              "id": "decodable-mvn-snapshots-local",
              "username": "aws",
              "password": "${env.CODEARTIFACT_AUTH_TOKEN}"
            }
            ]
      - name: Build
        run: mvn clean deploy -B -DskipTests -Dhttp.keepAlive=false -Dmaven.wagon.http.pool=false -Dmaven.wagon.httpconnectionManager.ttlSeconds=120
